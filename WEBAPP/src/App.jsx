import { useState, useEffect, useCallback } from 'react';

// Components
import LanguageSelector from './components/UI/LanguageSelector.jsx';
import MenuSection from './components/Menu/MenuSection.jsx';
import OrderPage from './components/Menu/OrderPage.jsx';
import ReviewModal from './components/Review/ReviewModal.jsx';
import WriteReviewPage from './components/Review/WriteReviewPage.jsx';
import NotificationPermissionModal from './components/UI/NotificationPermissionModal.jsx';
import PaymentModal from './components/Payment/PaymentModal.jsx';
import TossPaymentWidget from './components/Payment/TossPaymentWidget.jsx';
import PayPalPaymentWidget from './components/Payment/PayPalPaymentWidget.jsx';
import SuccessPage from './components/UI/SuccessPage.jsx';

// Data & Utils
import { sampleMenuData } from './datas/sampleData.js';
import { useMenu } from './hooks/useMenu.js';
import { formatPrice } from './utils/helpers.js';
import {
    isPushNotificationSupported,
    requestNotificationPermission,
    initializePushNotifications,
    scheduleReviewReminder,
} from './utils/pushNotifications.js';

function App() {
    // Ïï± Î°úÎìú Ïãú ÏïåÎ¶º Í∂åÌïú ÌôïÏù∏ Î∞è ÏöîÏ≤≠ + URL ÌååÎùºÎØ∏ÌÑ∞ Ï≤¥ÌÅ¨
    useEffect(() => {
        const checkNotificationPermission = async () => {
            // Ïù¥ÎØ∏ Í∂åÌïúÏùÑ ÏöîÏ≤≠ÌñàÎäîÏßÄ ÌôïÏù∏
            const hasAsked = localStorage.getItem('hasAskedForNotification');
            if (hasAsked) {
                setHasAskedForNotification(true);
                // Ïù¥ÎØ∏ Í∂åÌïúÏù¥ ÏûàÎã§Î©¥ Ìë∏Ïãú ÏïåÎ¶º Ï¥àÍ∏∞Ìôî
                if (Notification.permission === 'granted') {
                    await initializePushNotifications();
                }
                return;
            }

            // Ìë∏Ïãú ÏïåÎ¶ºÏùÑ ÏßÄÏõêÌïòÎäî Î∏åÎùºÏö∞Ï†ÄÏóêÏÑúÎßå Î™®Îã¨ ÌëúÏãú
            if (isPushNotificationSupported()) {
                // 1Ï¥à ÌõÑ Î™®Îã¨ ÌëúÏãú (ÏÇ¨Ïö©ÏûêÍ∞Ä ÌéòÏù¥ÏßÄÏóê Ï†ÅÏùëÌï† ÏãúÍ∞Ñ)
                setTimeout(() => {
                    setShowNotificationModal(true);
                }, 1000);
            }
        };

        // URLÏóêÏÑú Í≤∞Ï†ú ÏÑ±Í≥µ/Ïã§Ìå® Î∞è ÌéòÏù¥ÏßÄ ÌååÎùºÎØ∏ÌÑ∞ ÌôïÏù∏
        const urlParams = new URLSearchParams(window.location.search);
        const paymentParam = urlParams.get('payment');
        const pageParam = urlParams.get('page');

        if (paymentParam === 'success') {
            console.log('ÌÜ†Ïä§ Í≤∞Ï†ú ÏÑ±Í≥µ ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÎê®');

            // Ï†ÄÏû•Îêú Ïû•Î∞îÍµ¨Îãà Î≥µÏõê
            const savedItems = localStorage.getItem('pendingOrderItems');
            const savedCart = localStorage.getItem('pendingOrderCart');

            if (savedItems) {
                const items = JSON.parse(savedItems);
                setOrderedItems(items);
                localStorage.setItem('lastOrderedItems', JSON.stringify(items));

                // ÏûÑÏãú Ï†ÄÏû• Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
                localStorage.removeItem('pendingOrderItems');
                localStorage.removeItem('pendingOrderCart');
            }

            // Í≤∞Ï†ú ÏÑ±Í≥µ Ï≤òÎ¶¨
            const orderId = urlParams.get('orderId');
            const paymentKey = urlParams.get('paymentKey');
            const amount = urlParams.get('amount');

            setShowTossWidget(false);
            setShowPayPalWidget(false);
            setCurrentPage('success');

            // URL Ï†ïÎ¶¨
            window.history.replaceState({}, document.title, '/');
        } else if (paymentParam === 'fail') {
            console.log('ÌÜ†Ïä§ Í≤∞Ï†ú Ïã§Ìå® ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÎê®');
            const message = urlParams.get('message') || 'Í≤∞Ï†úÍ∞Ä Ïã§Ìå®ÌñàÏäµÎãàÎã§.';
            handlePaymentError(message);

            // URL Ï†ïÎ¶¨
            window.history.replaceState({}, document.title, '/');
        } else if (pageParam === 'review') {
            console.log('üîî Ìë∏Ïãú ÏïåÎ¶ºÏóêÏÑú Î¶¨Î∑∞ ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÎê®');
            // Ï†ÄÏû•Îêú Ï£ºÎ¨∏ Ï†ïÎ≥¥Í∞Ä ÏûàÏúºÎ©¥ Î¶¨Î∑∞ ÌéòÏù¥ÏßÄÎ°ú, ÏóÜÏúºÎ©¥ Î©îÎâ¥Î°ú
            const savedOrder = localStorage.getItem('lastOrderedItems');
            if (savedOrder) {
                try {
                    const items = JSON.parse(savedOrder);
                    setOrderedItems(items);
                    setCurrentPage('writeReview');
                } catch (e) {
                    console.error('Ï£ºÎ¨∏ Ï†ïÎ≥¥ ÌååÏã± Ïã§Ìå®:', e);
                    setCurrentPage('menu');
                }
            } else {
                setCurrentPage('menu');
            }

            // URL Ï†ïÎ¶¨
            window.history.replaceState({}, document.title, '/');
        }

        checkNotificationPermission();
    }, []);
    const [selectedLang, setSelectedLang] = useState('ko');
    const [showReviews, setShowReviews] = useState(null);
    const [currentPage, setCurrentPage] = useState('menu');
    const [showPaymentModal, setShowPaymentModal] = useState(false);
    const [showTossWidget, setShowTossWidget] = useState(false);
    const [showPayPalWidget, setShowPayPalWidget] = useState(false);
    const [paymentError, setPaymentError] = useState(null);
    const [orderedItems, setOrderedItems] = useState([]);
    const [showNotificationModal, setShowNotificationModal] = useState(false);
    const [hasAskedForNotification, setHasAskedForNotification] = useState(false);

    const { cart, addToCart, removeFromCart, getTotalItems, getTotalPrice, clearCart } = useMenu();

    // ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏†Îäî TossPaymentWidget Ïª¥Ìè¨ÎÑåÌä∏ÏóêÏÑú ÏßÅÏ†ë Î°úÎìú

    const getAllItems = () => {
        return Object.values(sampleMenuData.menu).flat();
    };

    const handleOrderClick = () => {
        setCurrentPage('order');
    };

    const handlePaymentClick = () => {
        setShowPaymentModal(true);
    };

    const handleTossPayment = async () => {
        // ÌÜ†Ïä§ Í≤∞Ï†ú Ï†ÑÏóê Ïû•Î∞îÍµ¨Îãà Ï†ÄÏû• (ÌéòÏù¥ÏßÄ Ïù¥Îèô ÎåÄÎπÑ)
        const cartItems = Object.keys(cart).map((itemId) => {
            const item = getAllItems().find((i) => i.id === parseInt(itemId));
            return { ...item, quantity: cart[itemId] };
        });
        localStorage.setItem('pendingOrderItems', JSON.stringify(cartItems));
        localStorage.setItem('pendingOrderCart', JSON.stringify(cart));

        setShowPaymentModal(false);
        setShowTossWidget(true);
    };

    const handlePayPalPayment = () => {
        setShowPaymentModal(false);
        setShowPayPalWidget(true);
    };

    const handlePaymentError = (errorMessage) => {
        setPaymentError(errorMessage);
        setShowTossWidget(false);
        setShowPayPalWidget(false);
        setTimeout(() => setPaymentError(null), 5000); // 5Ï¥à ÌõÑ ÏóêÎü¨ Î©îÏãúÏßÄ Ï†úÍ±∞
    };

    const handlePaymentComplete = (paymentDetails) => {
        console.log('üéâ Í≤∞Ï†ú ÏôÑÎ£å Ìï®Ïàò Ìò∏Ï∂úÎê®:', paymentDetails);
        setShowTossWidget(false);
        setShowPayPalWidget(false);

        // Ï£ºÎ¨∏Ìïú ÏïÑÏù¥ÌÖú Ï†ÄÏû•
        const items = Object.keys(cart).map((itemId) => {
            const item = getAllItems().find((i) => i.id === parseInt(itemId));
            return { ...item, quantity: cart[itemId] };
        });
        console.log('üì¶ Ï£ºÎ¨∏ ÏïÑÏù¥ÌÖúÎì§:', items);
        setOrderedItems(items);

        // Î¶¨Î∑∞ ÏïåÎ¶ºÏùÑ ÏúÑÌï¥ Ï£ºÎ¨∏ Ï†ïÎ≥¥Î•º localStorageÏóê Ï†ÄÏû•
        localStorage.setItem('lastOrderedItems', JSON.stringify(items));

        console.log('üìÑ ÌéòÏù¥ÏßÄÎ•º successÎ°ú Î≥ÄÍ≤Ω');
        setCurrentPage('success');
        clearCart();
    };

    const handleBackToMenu = () => {
        setCurrentPage('menu');
        setOrderedItems([]);
    };

    const handleGoToReview = () => {
        console.log('üì± Î¶¨Î∑∞ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô');
        setCurrentPage('writeReview');
    };

    const handleSubmitReview = (review) => {
        console.log('Î¶¨Î∑∞ ÏûëÏÑ±:', review);
        // Ïó¨Í∏∞ÏÑú Ïã§Ï†úÎ°úÎäî ÏÑúÎ≤ÑÏóê Î¶¨Î∑∞Î•º Ï†ÄÏû•Ìï¥Ïïº Ìï©ÎãàÎã§
        setCurrentPage('success');
    };

    const handleSkipReview = () => {
        setCurrentPage('success');
    };

    // ÏïåÎ¶º Í∂åÌïú ÌóàÏö© Ï≤òÎ¶¨
    const handleAllowNotifications = async () => {
        try {
            const granted = await requestNotificationPermission();
            if (granted) {
                await initializePushNotifications();
                console.log('Push notifications initialized successfully');
            }
            localStorage.setItem('hasAskedForNotification', 'true');
            setHasAskedForNotification(true);
            setShowNotificationModal(false);
        } catch (error) {
            console.error('Failed to enable notifications:', error);
            setShowNotificationModal(false);
        }
    };

    // ÏïåÎ¶º Í∂åÌïú Í±∞Î∂Ä Ï≤òÎ¶¨
    const handleDenyNotifications = () => {
        localStorage.setItem('hasAskedForNotification', 'true');
        setHasAskedForNotification(true);
        setShowNotificationModal(false);
    };

    if (currentPage === 'writeReview') {
        return (
            <WriteReviewPage
                orderedItems={orderedItems}
                selectedLang={selectedLang}
                onSubmitReview={handleSubmitReview}
                onSkip={handleSkipReview}
            />
        );
    }

    // window Ï†ÑÏó≠ Ìï®Ïàò Ï†úÍ±∞ - propsÎ°ú ÏßÅÏ†ë Ï†ÑÎã¨

    if (currentPage === 'success') {
        return (
            <SuccessPage
                onBackToMenu={handleBackToMenu}
                onGoToReview={handleGoToReview}
                orderedItems={orderedItems}
                selectedLang={selectedLang}
            />
        );
    }

    if (currentPage === 'order') {
        return (
            <>
                <OrderPage
                    cart={cart}
                    getAllItems={getAllItems}
                    selectedLang={selectedLang}
                    onAddToCart={addToCart}
                    onRemoveFromCart={removeFromCart}
                    onBackToMenu={() => setCurrentPage('menu')}
                    onPaymentClick={handlePaymentClick}
                    getTotalPrice={() => getTotalPrice(getAllItems)}
                />
                <PaymentModal
                    isOpen={showPaymentModal}
                    onClose={() => setShowPaymentModal(false)}
                    onTossPayment={handleTossPayment}
                    onPayPalPayment={handlePayPalPayment}
                />
                <TossPaymentWidget
                    isOpen={showTossWidget}
                    totalPrice={getTotalPrice(getAllItems)}
                    selectedLang={selectedLang}
                    onPaymentComplete={handlePaymentComplete}
                    onPaymentError={handlePaymentError}
                />
                <PayPalPaymentWidget
                    isOpen={showPayPalWidget}
                    onClose={() => setShowPayPalWidget(false)}
                    totalPrice={getTotalPrice(getAllItems)}
                    onPaymentComplete={handlePaymentComplete}
                    onPaymentError={handlePaymentError}
                />
            </>
        );
    }

    return (
        <div className='mobile-container'>
            <header className='header'>
                <h1 className='restaurant-name'>{sampleMenuData.restaurant.name}</h1>
                <p className='restaurant-subtitle'>{sampleMenuData.restaurant.subtitle}</p>

                <LanguageSelector
                    selectedLang={selectedLang}
                    onLanguageChange={setSelectedLang}
                />
            </header>

            <main>
                {Object.entries(sampleMenuData.menu).map(([category, items]) => (
                    <MenuSection
                        key={category}
                        category={category}
                        items={items}
                        selectedLang={selectedLang}
                        cart={cart}
                        onAddToCart={addToCart}
                        onRemoveFromCart={removeFromCart}
                        onShowReviews={setShowReviews}
                    />
                ))}
            </main>

            {getTotalItems() > 0 && (
                <div className='order-summary'>
                    <button
                        className='order-btn'
                        onClick={handleOrderClick}
                    >
                        Ï£ºÎ¨∏ÌïòÍ∏∞ ({getTotalItems()}Í∞ú) - {formatPrice(getTotalPrice(getAllItems), selectedLang)}
                    </button>
                </div>
            )}

            <ReviewModal
                item={showReviews}
                selectedLang={selectedLang}
                isOpen={!!showReviews}
                onClose={() => setShowReviews(null)}
            />

            {/* ÏïåÎ¶º Í∂åÌïú ÏöîÏ≤≠ Î™®Îã¨ */}
            <NotificationPermissionModal
                isOpen={showNotificationModal}
                onAllow={handleAllowNotifications}
                onDeny={handleDenyNotifications}
                selectedLang={selectedLang}
            />

            {/* Í≤∞Ï†ú ÏóêÎü¨ ÏïåÎ¶º */}
            {paymentError && (
                <div className='payment-error-toast'>
                    <div className='error-message'>[Ïò§Î•ò] {paymentError}</div>
                    <button onClick={() => setPaymentError(null)}>√ó</button>
                </div>
            )}
        </div>
    );
}

export default App;
