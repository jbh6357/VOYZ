name: Deploy VOYZ - AI Marketing Agent

on:
    push:
        branches: [main, dev]
    pull_request:
        branches: [main, dev]

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            # ì½”ë“œ ì²´í¬ì•„ì›ƒ
            - name: Checkout code
              uses: actions/checkout@v4

            # Node.js ì„¤ì • (React ë¹Œë“œ)
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18'

            # React ì›¹ì•± ë¹Œë“œ
            - name: Build React Web App
              run: |
                  cd WEBAPP
                  npm ci
                  npm run build

            # Java 17 ì„¤ì •
            - name: Setup JDK 17
              uses: actions/setup-java@v4
              with:
                  java-version: '17'
                  distribution: 'temurin'

            # React ë¹Œë“œë¥¼ Spring Bootì— í†µí•©
            - name: Integrate React into Spring Boot
              run: |
                  rm -rf backend/src/main/resources/static/*
                  cp -r WEBAPP/dist/* backend/src/main/resources/static/

            # Spring Boot ë¹Œë“œ
            - name: Build Spring Boot Application
              run: |
                  cd backend
                  chmod +x mvnw
                  ./mvnw clean package -DskipTests

            # EC2ë¡œ JAR íŒŒì¼ ë°°í¬
            - name: Deploy JAR to EC2
              uses: burnett01/rsync-deployments@6.0.0
              with:
                  switches: -avzr --delete
                  path: backend/target/
                  remote_path: /home/ubuntu/voyz-app/
                  remote_host: ${{ secrets.EC2_HOST }}
                  remote_user: ${{ secrets.EC2_USERNAME }}
                  remote_key: ${{ secrets.EC2_PRIVATE_KEY }}

            # Spring Boot ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘ (systemd ë°©ì‹)
            - name: Restart Spring Boot Service
              uses: appleboy/ssh-action@v0.1.5
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USERNAME }}
                  key: ${{ secrets.EC2_PRIVATE_KEY }}
                  timeout: 300s
                  command_timeout: 600s
                  script: |
                      # systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±
                      sudo tee /etc/systemd/system/voyz-app.service > /dev/null <<EOF
                      [Unit]
                      Description=VOYZ AI Marketing Agent
                      After=network.target

                      [Service]
                      Type=simple
                      User=ubuntu
                      WorkingDirectory=/home/ubuntu/voyz-app
                      ExecStart=/usr/bin/java -jar -Dspring.profiles.active=prod -Duser.timezone=Asia/Seoul -Dserver.port=8081 -Dspring.jpa.hibernate.ddl-auto=none -Djwt.secret=${{ secrets.JWT_SECRET }} /home/ubuntu/voyz-app/voiz-0.0.1-SNAPSHOT.jar
                      Restart=always
                      RestartSec=10
                      StandardOutput=journal
                      StandardError=journal

                      [Install]
                      WantedBy=multi-user.target
                      EOF

                      # systemd ë‹¤ì‹œ ë¡œë“œ ë° ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
                      sudo systemctl daemon-reload
                      sudo systemctl stop voyz-app || true
                      sudo systemctl start voyz-app
                      sudo systemctl enable voyz-app

                      # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
                      echo "Waiting for service to start..."
                      sleep 15

                      # ìƒíƒœ í™•ì¸
                      sudo systemctl status voyz-app --no-pager

                      # HTTP ì‘ë‹µ í™•ì¸
                      for i in {1..12}; do
                          if curl -f http://localhost:8081/actuator/health || curl -f http://localhost:8081; then
                              echo "âœ… Spring Boot application is running!"
                              break
                          fi
                          echo "â³ Attempt $i/12 - waiting 5 seconds..."
                          sleep 5
                      done

    deploy-ml:
        runs-on: ubuntu-latest
        needs: build-and-deploy

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v4
              with:
                  python-version: '3.9'

            # ML ì„œë¹„ìŠ¤ ë°°í¬
            - name: Deploy ML Service to EC2
              uses: burnett01/rsync-deployments@6.0.0
              with:
                  switches: -avzr --delete
                  path: ml/
                  remote_path: /home/ubuntu/voyz-ml/
                  remote_host: ${{ secrets.EC2_HOST }}
                  remote_user: ${{ secrets.EC2_USERNAME }}
                  remote_key: ${{ secrets.EC2_PRIVATE_KEY }}

            # ML ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘ (systemd ë°©ì‹)
            - name: Restart ML Service
              uses: appleboy/ssh-action@v0.1.5
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USERNAME }}
                  key: ${{ secrets.EC2_PRIVATE_KEY }}
                  timeout: 300s
                  command_timeout: 600s
                  script: |
                      cd /home/ubuntu/voyz-ml

                      # Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
                      sudo apt-get update
                      sudo apt-get install -y python3-pip python3-venv python3-dev

                      # ê¸°ì¡´ venvê°€ ìžˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ìƒì„±
                      if [ ! -d "venv" ]; then
                          python3 -m venv venv
                      fi
                      
                      # pip ì—…ê·¸ë ˆì´ë“œ ë° íŒ¨í‚¤ì§€ ì„¤ì¹˜
                      ./venv/bin/pip install --upgrade pip setuptools wheel
                      ./venv/bin/pip install -r requirements.txt

                      # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
                      echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" > .env
                      echo "GOOGLE_APPLICATION_CREDENTIALS=/home/ubuntu/voyz-ml/google-credentials.json" >> .env
                      echo "FASTAPI_HOST=0.0.0.0" >> .env
                      echo "FASTAPI_PORT=8000" >> .env
                      echo "FASTAPI_DEBUG=False" >> .env

                      # Google Cloud ì„œë¹„ìŠ¤ ê³„ì • í‚¤ íŒŒì¼ ìƒì„±
                      echo '${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}' > google-credentials.json
                      chmod 600 google-credentials.json  # ë³´ì•ˆì„ ìœ„í•œ ê¶Œí•œ ì„¤ì •

                      # JSON íŒŒì¼ ìœ íš¨ì„± ê²€ì¦
                      python3 -c "import json; json.load(open('google-credentials.json'))" || (echo "Invalid JSON in GOOGLE_APPLICATION_CREDENTIALS secret" && exit 1)

                      # Google Cloud ì¸ì¦ í…ŒìŠ¤íŠ¸
                      export GOOGLE_APPLICATION_CREDENTIALS=/home/ubuntu/voyz-ml/google-credentials.json
                      ./venv/bin/python -c "from google.cloud import vision; print('Google Cloud Vision API ì—°ê²° ì„±ê³µ')" || echo "Google Cloud ì¸ì¦ ì‹¤íŒ¨ - OCR ê¸°ëŠ¥ ë¹„í™œì„±í™”ë¨"

                      # systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±
                      sudo tee /etc/systemd/system/voyz-ml.service > /dev/null <<EOF
                      [Unit]
                      Description=VOYZ ML Service - FastAPI
                      After=network.target

                      [Service]
                      Type=simple
                      User=ubuntu
                      WorkingDirectory=/home/ubuntu/voyz-ml
                      Environment="PATH=/home/ubuntu/voyz-ml/venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
                      Environment="GOOGLE_APPLICATION_CREDENTIALS=/home/ubuntu/voyz-ml/google-credentials.json"
                      EnvironmentFile=/home/ubuntu/voyz-ml/.env
                      ExecStart=/home/ubuntu/voyz-ml/venv/bin/python -m uvicorn main:app --host 0.0.0.0 --port 8000
                      Restart=always
                      RestartSec=10
                      StandardOutput=journal
                      StandardError=journal

                      [Install]
                      WantedBy=multi-user.target
                      EOF

                      # systemd ë‹¤ì‹œ ë¡œë“œ ë° ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
                      sudo systemctl daemon-reload
                      sudo systemctl stop voyz-ml || true
                      sudo systemctl start voyz-ml
                      sudo systemctl enable voyz-ml

                      # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
                      echo "Waiting for ML service to start..."
                      sleep 10

                      # ìƒíƒœ í™•ì¸
                      sudo systemctl status voyz-ml --no-pager

                      # HTTP ì‘ë‹µ í™•ì¸
                      for i in {1..10}; do
                          if curl -f http://localhost:8000/docs || curl -f http://localhost:8000; then
                              echo "âœ… ML Service is running!"
                              break
                          fi
                          echo "â³ Attempt $i/10 - waiting 3 seconds..."
                          sleep 3
                      done

                      echo "ðŸŽ‰ VOYZ AI Marketing Agent deployment completed!"
