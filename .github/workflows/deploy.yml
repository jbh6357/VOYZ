name: Deploy VOYZ Application
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    # Node.js 설정 (React 빌드용)
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    # React 앱 빌드
    - name: Install React dependencies
      run: |
        cd WEBAPP
        npm ci
    
    - name: Build React app
      run: |
        cd WEBAPP
        npm run build
        
    # Java 설정 (Spring Boot 빌드용)
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    # React 빌드 파일을 Spring Boot static 폴더로 복사
    - name: Copy React build to Spring Boot
      run: |
        rm -rf backend/src/main/resources/static/*
        cp -r WEBAPP/dist/* backend/src/main/resources/static/
    
    # Spring Boot 빌드
    - name: Grant execute permission for mvnw
      run: chmod +x backend/mvnw
    
    - name: Build Spring Boot with React
      run: |
        cd backend
        ./mvnw clean package -DskipTests
    
    # 빌드 아티팩트 업로드
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: voyz-app
        path: backend/target/*.jar
  
  deploy-ml:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install ML dependencies
      run: |
        cd ml
        pip install -r requirements.txt
    
    - name: Test ML API
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        cd ml
        python -c "import main; print('ML API 모듈 로드 성공')"
